<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Calculadora de Costos Arbitrales</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">

<style>
  :root{
    --vino:#68092b;
    --vino-oscuro:#42041a;
    --dorado:#d2ae6d;
    --dorado-oscuro:#b8955a;
    --gris:#e7e7e7;
    --texto:#2d2d2d;
  }

  *{ box-sizing:border-box; }

  body{
    font-family:'Poppins', sans-serif;
    background:#f8f3ed;
    margin:0;
    padding:20px;
    color:var(--texto);
  }

  .calc-container{
    max-width:960px;
    margin:0 auto;
    background:white;
    border-radius:14px;
    border:2px solid var(--vino);
    padding:35px 40px;
    box-shadow:0 18px 35px rgba(66,4,26,0.12);
  }

  h1{
    font-family:"Montserrat", sans-serif;
    font-size:30px;
    font-weight:700;
    color:var(--vino);
    text-align:center;
    margin:0 0 6px;
  }

  .sub{
    text-align:center;
    margin-bottom:24px;
    color:#5c5c5c;
    font-size:15px;
  }

  .top-links{
    display:flex;
    gap:12px;
    justify-content:center;
    flex-wrap:wrap;
    margin-bottom:22px;
  }

  .top-link{
    padding:10px 18px;
    border:2px solid var(--vino);
    color:var(--vino);
    border-radius:10px;
    font-weight:600;
    text-decoration:none;
    font-size:14px;
    transition:all .2s ease;
    background:#fff;
  }

  .top-link:hover{
    background:var(--vino);
    color:white;
  }

  .choice-row{
    display:flex;
    gap:12px;
    margin-bottom:24px;
    flex-wrap:wrap;
    justify-content:center;
  }

  .choice{
    position:relative;
    display:flex;
    align-items:center;
    gap:8px;
    padding:12px 18px;
    border-radius:12px;
    border:2px solid var(--vino);
    color:var(--vino);
    font-weight:700;
    cursor:pointer;
    transition:all .2s ease;
    background:#fff;
  }

  .choice input{ display:none; }

  .choice.active{
    background:var(--vino);
    color:white;
    box-shadow:0 10px 20px rgba(104,9,43,0.2);
  }

  .section-card{
    border:1px solid #ebebeb;
    background:#fcf9f5;
    border-radius:12px;
    padding:18px 20px 14px;
    margin-bottom:18px;
  }

  .section-header{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:12px;
  }

  .section-title{
    font-size:18px;
    font-family:Montserrat, sans-serif;
    font-weight:700;
    color:var(--vino);
    margin:0;
  }

  .field-grid{
    display:grid;
    grid-template-columns:1fr auto;
    gap:12px;
    align-items:end;
  }

  .form-group{ margin-bottom:12px; }

  .form-group label{
    display:block;
    font-weight:600;
    font-size:14px;
    margin-bottom:6px;
    color:#4a4a4a;
  }

  .input-wrap{
    display:flex;
    align-items:center;
    background:white;
    border:1px solid #dcdcdc;
    border-radius:10px;
    padding:0 10px;
    box-shadow:inset 0 1px 2px rgba(0,0,0,0.04);
    width:100%;
  }

  .input-wrap .prefix{
    font-weight:700;
    color:var(--vino);
    margin-right:10px;
  }

  .input-wrap input,
  .form-group select{
    width:100%;
    padding:10px 8px;
    border:none;
    font-size:15px;
    font-family:'Poppins', sans-serif;
    background:transparent;
    outline:none;
  }

  .form-group select{
    border:1px solid #dcdcdc;
    border-radius:10px;
    background:white;
    padding:10px 8px;
  }

  .currency-toggle{
    display:inline-flex;
    background:#f1e7da;
    border-radius:30px;
    padding:4px;
    border:1px solid var(--dorado-oscuro);
    gap:6px;
  }

  .currency-btn{
    border:none;
    background:transparent;
    padding:8px 14px;
    border-radius:20px;
    font-weight:700;
    color:var(--vino);
    cursor:pointer;
    transition:all .2s ease;
  }

  .currency-btn.active{
    background:var(--dorado);
    color:var(--vino-oscuro);
  }

  .currency-btn:disabled{
    cursor:not-allowed;
    opacity:0.7;
  }

  .pretension-box{
    background:white;
    border:1px solid #e3e0dc;
    padding:16px 16px 8px;
    border-radius:12px;
    margin-bottom:12px;
    position:relative;
    box-shadow:0 6px 12px rgba(0,0,0,0.04);
  }

  .pretension-title{
    font-size:16px;
    font-family:Montserrat, sans-serif;
    font-weight:700;
    color:var(--vino);
    margin:0 0 10px;
  }

  .delete-btn{
    position:absolute;
    top:10px;
    right:10px;
    background:none;
    border:none;
    font-size:16px;
    color:var(--vino);
    font-weight:700;
    cursor:pointer;
    transition:0.2s;
  }

  .delete-btn:hover{ color:var(--vino-oscuro); }

  .add-btn{
    width:100%;
    background:var(--dorado);
    color:var(--vino-oscuro);
    border:none;
    padding:14px;
    border-radius:30px;
    font-weight:700;
    letter-spacing:0.3px;
    cursor:pointer;
    box-shadow:0 8px 15px rgba(0,0,0,0.08);
    transition:all .2s ease;
  }

  .add-btn:hover{ background:var(--dorado-oscuro); }

  .cta{
    width:100%;
    background:var(--vino);
    color:white;
    border:none;
    padding:15px;
    border-radius:14px;
    font-weight:800;
    font-size:16px;
    cursor:pointer;
    box-shadow:0 14px 25px rgba(66,4,26,0.25);
    transition:all .2s ease;
    margin-top:10px;
  }

  .cta:hover{ background:var(--vino-oscuro); }

  .result{
    margin-top:24px;
    padding:22px;
    border-radius:14px;
    background:#fefbf6;
    border:2px solid var(--dorado);
    box-shadow:0 10px 18px rgba(0,0,0,0.08);
  }

  .result h2{
    font-size:20px;
    font-family:Montserrat, sans-serif;
    font-weight:700;
    color:var(--vino);
    margin:0 0 12px;
  }

  .result p{
    font-size:15px;
    margin:6px 0;
    color:#4a4a4a;
  }

  .result span{
    font-weight:700;
    color:var(--vino);
  }

  /* MODAL DE RESULTADOS */
  body.no-scroll{ overflow:hidden; }

  .modal-overlay{
    position:fixed;
    inset:0;
    background:rgba(66,4,26,0.55);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
    opacity:0;
    visibility:hidden;
    transition:all .2s ease;
    z-index:999;
  }

  .modal-overlay.show{ opacity:1; visibility:visible; }

  .modal-card{
    background:#fff;
    border-radius:16px;
    width:100%;
    max-width:720px;
    border:2px solid var(--dorado-oscuro);
    box-shadow:0 20px 36px rgba(0,0,0,0.18);
    overflow:hidden;
  }

  .modal-header{
    padding:16px 22px 0;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }

  .modal-title{
    margin:0;
    font-family:'Montserrat', sans-serif;
    font-size:20px;
    font-weight:700;
    color:var(--vino-oscuro);
  }

  .modal-body{
    padding:8px 22px 14px;
  }

  .modal-box{
    border:1px solid #e7e0d4;
    border-radius:12px;
    background:#fdf8f1;
    padding:14px 14px 6px;
  }

  .modal-row{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    padding:10px 10px;
    border-bottom:1px solid #efe5d7;
  }

  .modal-row:last-child{ border-bottom:none; }

  .modal-label{
    font-weight:700;
    color:var(--vino);
  }

  .modal-value{
    font-weight:700;
    color:#1f1f1f;
    text-align:right;
  }

  .modal-total{
    background:#fff7eb;
    border:1px solid var(--dorado);
    border-radius:12px;
    padding:12px 14px 6px;
    margin-top:14px;
  }

  .modal-actions{
    display:flex;
    gap:12px;
    padding:16px 22px 24px;
    flex-wrap:nowrap;
    justify-content:flex-end;
    align-items:center;
    overflow-x:auto;
    background:#fbf4ea;
    border-top:1px solid #ecdfce;
  }

  .modal-btn{
    border:none;
    border-radius:12px;
    padding:12px 16px;
    font-weight:800;
    font-size:14px;
    cursor:pointer;
    transition:all .2s ease;
    color:white;
    background:var(--vino);
    box-shadow:0 10px 20px rgba(104,9,43,0.18);
  }

  .modal-btn:hover{ background:var(--vino-oscuro); }

  .modal-btn.secondary{
    background:var(--dorado);
    color:var(--vino-oscuro);
    box-shadow:0 10px 18px rgba(0,0,0,0.08);
  }

  .modal-btn.secondary:hover{ background:var(--dorado-oscuro); }

  .modal-btn.outline{
    background:white;
    color:var(--vino);
    border:2px solid var(--vino);
    box-shadow:none;
  }

  .modal-btn.outline:hover{ background:var(--vino); color:white; }

  @media(max-width:700px){
    body{ padding:12px; }
    .calc-container{ padding:24px; }
    .field-grid{ grid-template-columns:1fr; }
    .choice-row{ flex-direction:column; }
  }

</style>
</head>
<body>

<div class="calc-container">
  <h1>Calculadora de Costos</h1>
  <div class="sub">Calcule los costos arbitrales según las pretensiones determinadas o indeterminadas.</div>

  <div class="top-links">
    <a class="top-link" href="#">TABLA DE COSTOS ARBITRALES</a>
    <a class="top-link" href="#">REGLAMENTO DE COSTOS ARBITRALES</a>
  </div>

  <div class="choice-row">
    <label class="choice active" for="arbitroUnico">
      <input type="radio" id="arbitroUnico" name="tipoArbitro" value="unico" checked>
      Calcular con Árbitro Único
    </label>
    <label class="choice" for="tribunalArbitral">
      <input type="radio" id="tribunalArbitral" name="tipoArbitro" value="tribunal">
      Calcular con Tribunal Arbitral
    </label>
  </div>

  <div class="section-card">
    <div class="section-header">
      <h3 class="section-title">Monto Contractual</h3>
      <div class="currency-toggle" data-target="currency">
        <button class="currency-btn active" type="button" data-currency="PEN">S/</button>
        <button class="currency-btn" type="button" data-currency="USD">USD</button>
      </div>
    </div>
    <div class="form-group">
      <label class="monto-contractual-label">Monto contractual (S/):</label>
      <div class="input-wrap">
        <span class="prefix currency-prefix">S/</span>
        <input type="number" id="montoContractual" placeholder="Ingrese el monto contractual">
      </div>
    </div>
  </div>

  <div class="section-card">
    <div class="section-header">
      <h3 class="section-title">Pretensiones</h3>
      <div class="currency-toggle" data-target="currency">
        <button class="currency-btn active" type="button" data-currency="PEN">S/</button>
        <button class="currency-btn" type="button" data-currency="USD">USD</button>
      </div>
    </div>
    <div id="pretensiones-container"></div>
    <button class="add-btn" onclick="agregarPretension()">+ AGREGAR PRETENSIÓN</button>
  </div>

  <button class="cta" onclick="calcular()">CALCULAR</button>

  <div id="resultado" class="result" style="display:none;">
    <h2>Resumen de costos</h2>
    <p><strong>Cuantía Total:</strong> <span id="cuantiaTotal"></span></p>
    <p><strong>Gastos Administrativos:</strong> <span id="gastosAdmin"></span></p>
    <p><strong>Honorarios Arbitrales:</strong> <span id="honorariosArbitrales"></span></p>
    <p><strong>Total sin IGV:</strong> <span id="totalPagarSinIGV"></span></p>
    <p><strong>Total con IGV (18%):</strong> <span id="totalPagarConIGV"></span></p>
  </div>

</div>

<div id="resultado-modal" class="modal-overlay" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <h3 id="modalTitle" class="modal-title">Resumen de costos</h3>
    </div>
    <div class="modal-body">
      <div class="modal-box">
        <div class="modal-row">
          <span class="modal-label">Monto de la cuantía:</span>
          <span id="modalCuantia" class="modal-value">—</span>
        </div>
        <div class="modal-row">
          <span class="modal-label">Servicio de Administración de Arbitraje</span>
          <span id="modalGastos" class="modal-value">—</span>
        </div>
        <div class="modal-row">
          <span id="modalHonorariosLabel" class="modal-label">Honorarios Árbitro Único</span>
          <span id="modalHonorarios" class="modal-value">—</span>
        </div>
      </div>

      <div class="modal-total">
        <div class="modal-row">
          <span class="modal-label">TOTAL</span>
          <span id="modalTotal" class="modal-value">—</span>
        </div>
        <div class="modal-row">
          <span class="modal-label">TOTAL con IGV (18%)</span>
          <span id="modalTotalIGV" class="modal-value">—</span>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" type="button" onclick="descargarPDF()">DESCARGAR PDF</button>
      <button class="modal-btn" type="button" onclick="reiniciarCalculadora()">REALIZAR NUEVO CÁLCULO</button>
      <button class="modal-btn outline" type="button" id="modalCurrencyBtn" onclick="cambiarMonedaModal()">CAMBIAR A (USD) DÓLARES</button>
    </div>
  </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const EXCHANGE_RATE = 3.555;

/* TABLAS - ANEXO N°2 */
const gastosAdminBrackets = [
  { minQ: 20001, maxQ: 60000, baseExcess: 15000, rate: 0.06, minAmt:1200, maxAmt:3900 },
  { minQ: 60001, maxQ:150000, baseExcess:60000, rate:0.04, minAmt:3900, maxAmt:7500 },
  { minQ:150001, maxQ:300000, baseExcess:150000, rate:0.02, minAmt:7500, maxAmt:10500 },
  { minQ:300001, maxQ:500000, baseExcess:300000, rate:0.015,minAmt:10500,maxAmt:13500 },
  { minQ:500001, maxQ:1000000, baseExcess:500000, rate:0.01,minAmt:13500,maxAmt:18500 },
  { minQ:1000001,maxQ:5000000, baseExcess:1000000, rate:0.005,minAmt:18500,maxAmt:38500 },
  { minQ:5000001,maxQ:50000000,baseExcess:5000000, rate:0.002,minAmt:38500,maxAmt:128500 },
  { minQ:50000000.01,maxQ:Infinity,baseExcess:50000000,rate:0.003,minAmt:128500,maxAmt:null }
];

const arbitroUnicoBrackets = [
  { minQ:20001,maxQ:60000, baseExcess:15000, rate:0.065,minAmt:1300,maxAmt:4225 },
  { minQ:60001,maxQ:150000,baseExcess:60000,rate:0.07,minAmt:4225,maxAmt:10525 },
  { minQ:150001,maxQ:300000,baseExcess:150000,rate:0.02,minAmt:10525,maxAmt:13525 },
  { minQ:300001,maxQ:500000,baseExcess:300000,rate:0.006,minAmt:13525,maxAmt:14725 },
  { minQ:500001,maxQ:1000000,baseExcess:500000,rate:0.008,minAmt:14725,maxAmt:18725 },
  { minQ:1000001,maxQ:5000000,baseExcess:1000000,rate:0.005,minAmt:18725,maxAmt:38725 },
  { minQ:5000001,maxQ:50000000,baseExcess:5000000,rate:0.003,minAmt:38725,maxAmt:173725 },
  { minQ:50000000.01,maxQ:Infinity,baseExcess:50000000,rate:0.003,minAmt:173725,maxAmt:null }
];

const tribunalBrackets = [
  { minQ:20001,maxQ:60000,baseExcess:15000,rate:0.30,minAmt:4500,maxAmt:18000 },
  { minQ:60001,maxQ:150000,baseExcess:60000,rate:0.12,minAmt:18000,maxAmt:28800 },
  { minQ:150001,maxQ:300000,baseExcess:150000,rate:0.05,minAmt:28800,maxAmt:36300 },
  { minQ:300001,maxQ:500000,baseExcess:300000,rate:0.035,minAmt:36300,maxAmt:43300 },
  { minQ:500001,maxQ:1000000,baseExcess:500000,rate:0.026,minAmt:43300,maxAmt:56300 },
  { minQ:1000001,maxQ:5000000,baseExcess:1000000,rate:0.015,minAmt:56300,maxAmt:116300 },
  { minQ:5000001,maxQ:50000000,baseExcess:5000000,rate:0.008,minAmt:116300,maxAmt:476300 },
  { minQ:50000000.01,maxQ:Infinity,baseExcess:50000000,rate:0.008,minAmt:476300,maxAmt:null }
];

/* SISTEMA DE ESTADO Y PRETENSIONES */
const crearEstadoBase = () => ({
  moneda: 'PEN',
  montoContractual: '',
  pretensiones: [{ tipo: 'determinada', monto: '', motivo: 'penalidad' }]
});

const estadoCalculadoras = {
  unico: crearEstadoBase(),
  tribunal: crearEstadoBase()
};

let pretensionCount = 0;
let modoActual = 'unico';
let ultimoResultado = null;

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.choice input').forEach(radio => {
    radio.addEventListener('change', (e) => manejarCambioModo(e.target.value));
  });

  document.querySelectorAll('.currency-toggle .currency-btn').forEach(btn => {
    btn.addEventListener('click', () => cambiarMoneda(btn.dataset.currency));
  });

  actualizarEleccion();
  renderizarEstado(modoActual);
});

function formatoMoneda(valor, simbolo){
  return `${simbolo} ${Number(valor || 0).toLocaleString('es-PE', { minimumFractionDigits:2, maximumFractionDigits:2 })}`;
}

function manejarCambioModo(nuevoModo){
  guardarEstadoActual();
  modoActual = nuevoModo;
  renderizarEstado(modoActual);
  actualizarEleccion();
}

function actualizarEleccion(){
  document.querySelectorAll('.choice').forEach(choice => {
    const input = choice.querySelector('input');
    choice.classList.toggle('active', input.checked);
  });
}

function cambiarMoneda(moneda){
  const estado = estadoCalculadoras[modoActual];
  estado.moneda = moneda;
  actualizarToggleMoneda(moneda);
  actualizarEtiquetasMoneda(moneda);
  const modalAbierto = document.getElementById('resultado-modal').classList.contains('show');
  if(modalAbierto && ultimoResultado){
    renderizarModal(moneda);
  }
}

function actualizarToggleMoneda(moneda){
  document.querySelectorAll('.currency-toggle').forEach(toggle => {
    toggle.querySelectorAll('.currency-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.currency === moneda);
    });
  });
}

function actualizarEtiquetasMoneda(moneda){
  const simbolo = moneda === 'USD' ? 'USD' : 'S/';

  document.querySelectorAll('.currency-prefix').forEach(pref => {
    pref.textContent = simbolo;
  });

  const labelMonto = document.querySelector('.monto-contractual-label');
  if(labelMonto){
    labelMonto.textContent = `Monto contractual (${simbolo}):`;
  }

  document.querySelectorAll('.pretension-box').forEach(box => {
    const labelMontoPret = box.querySelector('[id^="montoDiv"] label');
    if(labelMontoPret) labelMontoPret.textContent = `Monto de la pretensión (${simbolo}):`;
  });
}

function agregarPretension(data = { tipo: 'determinada', monto: '', motivo: 'penalidad' }){
  pretensionCount++;

  const id = pretensionCount;
  const container = document.getElementById("pretensiones-container");

  const div = document.createElement("div");
  div.className="pretension-box";
  div.id=`pret-${id}`;

  div.innerHTML=`
    <button class="delete-btn" onclick="eliminarPret(${id})">✖</button>
    <h4 class="pretension-title">Pretensión ${id}</h4>

    <div class="form-group">
      <label>Tipo de pretensión:</label>
      <select id="tipo${id}" onchange="toggleInd(${id})">
        <option value="determinada">Determinada</option>
        <option value="indeterminada">Indeterminada</option>
      </select>
    </div>

    <div class="form-group" id="montoDiv${id}">
      <label>Monto de la pretensión (S/):</label>
      <div class="input-wrap">
        <span class="prefix currency-prefix">S/</span>
        <input type="number" id="monto${id}" placeholder="Solo si es determinada">
      </div>
    </div>

    <div class="form-group" id="motivoDiv${id}" style="display:none;">
      <label>Motivo:</label>
      <select id="motivo${id}">
        <option value="penalidad">Penalidad (10%)</option>
        <option value="nulidad">Nulidad o resolución (100%)</option>
        <option value="indet">Indeterminada (5%)</option>
      </select>
    </div>
  `;

  container.appendChild(div);

  document.getElementById(`tipo${id}`).value = data.tipo;
  document.getElementById(`monto${id}`).value = data.monto;
  document.getElementById(`motivo${id}`).value = data.motivo;

  toggleInd(id);
  renumerarPretensiones();
  actualizarEtiquetasMoneda(estadoCalculadoras[modoActual].moneda);
}

function eliminarPret(id){
    document.getElementById(`pret-${id}`).remove();
    renumerarPretensiones();
}

function toggleInd(i){
  const tipo = document.getElementById(`tipo${i}`).value;
  document.getElementById(`montoDiv${i}`).style.display = tipo==="determinada" ? "block" : "none";
  document.getElementById(`motivoDiv${i}`).style.display = tipo==="indeterminada" ? "block" : "none";
}

function renumerarPretensiones() {
  const pretensiones = document.querySelectorAll('.pretension-box');

  let num = 1;
  pretensiones.forEach(box => {
    // actualizar título
    const title = box.querySelector('.pretension-title');
    title.textContent = `Pretensión ${num}`;

    // actualizar IDs internos para no romper lógica
    box.id = `pret-${num}`;

    // actualizar select e inputs internos
    box.querySelectorAll('[id]').forEach(el => {
      const base = el.id.replace(/[0-9]/g, ''); // quita números
      el.id = base + num;
    });

    // actualizar manejadores de evento inline (onclick, onchange)
    const deleteBtn = box.querySelector('.delete-btn');
    deleteBtn.setAttribute('onclick', `eliminarPret(${num})`);

    const selectTipo = box.querySelector('select[id^="tipo"]');
    selectTipo.setAttribute('onchange', `toggleInd(${num})`);

    num++;
  });

  pretensionCount = pretensiones.length;
}

function guardarEstadoActual(){
  const estado = estadoCalculadoras[modoActual];
  estado.montoContractual = document.getElementById('montoContractual').value;

  const pretensiones = [];
  document.querySelectorAll('.pretension-box').forEach(box => {
    const id = box.id.split('-')[1];
    const tipo = document.getElementById(`tipo${id}`).value;
    const monto = document.getElementById(`monto${id}`).value;
    const motivo = document.getElementById(`motivo${id}`).value;
    pretensiones.push({ tipo, monto, motivo });
  });

  estado.pretensiones = pretensiones;
}

function renderizarEstado(modo){
  const estado = estadoCalculadoras[modo];

  document.getElementById('montoContractual').value = estado.montoContractual;

  const container = document.getElementById('pretensiones-container');
  container.innerHTML = '';
  pretensionCount = 0;

  estado.pretensiones.forEach(pret => agregarPretension(pret));

  actualizarToggleMoneda(estado.moneda);
  actualizarEtiquetasMoneda(estado.moneda);
}

function calcular(){
  guardarEstadoActual();
  const estado = estadoCalculadoras[modoActual];
  const montoContractual = parseFloat(estado.montoContractual) || 0;
  const moneda = estado.moneda;
  const simbolo = moneda === 'USD' ? 'USD' : 'S/';
  const tasa = moneda === 'USD' ? EXCHANGE_RATE : 1;

  const montoContractualSoles = montoContractual * tasa;
  const cuantiaSoles = calcularCuantia(montoContractualSoles, estado.pretensiones, tasa);

  if(cuantiaSoles < 20001){
    alert("La cuantía total está por debajo de S/ 20,001 (primer rango oficial).");
    return;
  }

  const gastosAdminSoles = calcularPorTabla(cuantiaSoles, gastosAdminBrackets);
  const honorariosSoles = calcularPorTabla(cuantiaSoles, modoActual === 'unico' ? arbitroUnicoBrackets : tribunalBrackets);

  const totalSoles = gastosAdminSoles + honorariosSoles;
  const totalIgvSoles = totalSoles * 1.18;

  const divisor = moneda === 'USD' ? EXCHANGE_RATE : 1;

  ultimoResultado = {
    moneda,
    simbolo,
    cuantia: cuantiaSoles / divisor,
    gastos: gastosAdminSoles / divisor,
    honorarios: honorariosSoles / divisor,
    total: totalSoles / divisor,
    totalIgv: totalIgvSoles / divisor,
  };

  renderizarModal(moneda);
}

function calcularCuantia(montoContractualSoles, pretensiones, tasa){
  let cuantia = 0;

  pretensiones.forEach((pret) => {
    if(pret.tipo === 'determinada'){
      const montoPret = parseFloat(pret.monto) || 0;
      cuantia += montoPret * tasa;
    } else {
      if(pret.motivo === 'penalidad'){
        cuantia += montoContractualSoles * 0.1;
      } else if(pret.motivo === 'nulidad'){
        cuantia += montoContractualSoles;
      } else {
        cuantia += montoContractualSoles * 0.05;
      }
    }
  });

  return cuantia;
}

function calcularPorTabla(cuantia, tabla){
  for(const b of tabla){
    if(cuantia >= b.minQ && cuantia <= b.maxQ){
      let calc = b.rate * (cuantia - b.baseExcess);
      if(calc < b.minAmt) calc = b.minAmt;
      if(b.maxAmt !== null && calc > b.maxAmt) calc = b.maxAmt;
      return calc;
    }
  }
  return 0;
}

function renderizarModal(moneda){
  const simbolo = moneda === 'USD' ? 'USD' : 'S/';

  document.getElementById('modalTitle').textContent = modoActual === 'unico' ? 'Árbitro Único' : 'Tribunal Arbitral';
  document.getElementById('modalHonorariosLabel').textContent = modoActual === 'unico' ? 'Honorarios Árbitro Único' : 'Honorarios Tribunal Arbitral';

  const res = ultimoResultado;
  document.getElementById('modalCuantia').textContent = formatoMoneda(res.cuantia, simbolo);
  document.getElementById('modalGastos').textContent = formatoMoneda(res.gastos, simbolo);
  document.getElementById('modalHonorarios').textContent = formatoMoneda(res.honorarios, simbolo);
  document.getElementById('modalTotal').textContent = formatoMoneda(res.total, simbolo);
  document.getElementById('modalTotalIGV').textContent = formatoMoneda(res.totalIgv, simbolo);

  const modal = document.getElementById('resultado-modal');
  modal.classList.add('show');
  document.body.style.overflow = 'hidden';

  const currencyBtn = document.getElementById('modalCurrencyBtn');
  const nuevaMoneda = moneda === 'USD' ? 'PEN' : 'USD';
  currencyBtn.textContent = `CAMBIAR A (${nuevaMoneda === 'USD' ? 'USD' : 'S/'}) ${nuevaMoneda === 'USD' ? 'DÓLARES' : 'SOLES'}`;
}

function cerrarModal(){
  const modal = document.getElementById('resultado-modal');
  modal.classList.remove('show');
  document.body.style.overflow = 'auto';
}

function cambiarMonedaModal(){
  const nuevaMoneda = estadoCalculadoras[modoActual].moneda === 'USD' ? 'PEN' : 'USD';
  cambiarMoneda(nuevaMoneda);
  calcular();
}

function descargarPDF(){
  if(!ultimoResultado){
    alert('Primero realiza un cálculo.');
    return;
  }

  if(!window.jspdf){
    alert('No se pudo cargar la librería para exportar a PDF.');
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });

  const simbolo = ultimoResultado.moneda === 'USD' ? 'USD' : 'S/';
  const titulo = modoActual === 'unico' ? 'Árbitro Único' : 'Tribunal Arbitral';
  const fechaTexto = new Intl.DateTimeFormat('es-PE', { dateStyle:'short', timeStyle:'short' }).format(new Date());

  const margin = 48;
  const pageWidth = doc.internal.pageSize.getWidth();
  const boxWidth = pageWidth - (margin * 2);
  const rowHeight = 30;

  let y = 64;

  doc.setFont('helvetica', 'bold');
  doc.setFontSize(18);
  doc.setTextColor(104, 9, 43);
  doc.text('Costos Arbitrales', margin, y);

  y += 20;
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(11);
  doc.setTextColor(50, 50, 50);
  doc.text(`Fecha: ${fechaTexto} | Modo: ${titulo} | Moneda: ${simbolo === 'USD' ? 'USD' : 'PEN'} | Tasa SUNAT: ${EXCHANGE_RATE}`, margin, y);

  const filas = [
    { etiqueta: 'Monto de la cuantía:', valor: formatoMoneda(ultimoResultado.cuantia, simbolo) },
    { etiqueta: 'Servicio de Administración de Arbitraje', valor: formatoMoneda(ultimoResultado.gastos, simbolo) },
    { etiqueta: titulo === 'Árbitro Único' ? 'Honorarios Árbitro Único' : 'Honorarios Tribunal Arbitral', valor: formatoMoneda(ultimoResultado.honorarios, simbolo) },
    { etiqueta: 'TOTAL', valor: formatoMoneda(ultimoResultado.total, simbolo), destacado:true },
    { etiqueta: 'TOTAL con IGV (18%)', valor: formatoMoneda(ultimoResultado.totalIgv, simbolo), destacado:true }
  ];

  y += 28;
  const boxHeight = (rowHeight * filas.length) + 12;
  doc.setDrawColor(184, 149, 90);
  doc.setFillColor(253, 248, 241);
  doc.roundedRect(margin, y, boxWidth, boxHeight, 10, 10, 'FD');

  let cursorY = y + 26;
  filas.forEach(fila => {
    if(fila.destacado){
      doc.setFillColor(247, 236, 213);
      doc.rect(margin + 8, cursorY - 16, boxWidth - 16, rowHeight - 6, 'F');
    }

    doc.setFont('helvetica', fila.destacado ? 'bold' : 'normal');
    doc.setFontSize(fila.destacado ? 12 : 11);
    doc.setTextColor(66, 4, 26);
    doc.text(fila.etiqueta, margin + 16, cursorY);
    doc.text(fila.valor, margin + boxWidth - 16, cursorY, { align:'right' });

    cursorY += rowHeight;
  });

  doc.setFont('helvetica', 'normal');
  doc.setFontSize(9);
  doc.setTextColor(120);
  doc.text('Reporte generado automáticamente por la calculadora de costos arbitrales.', margin, doc.internal.pageSize.getHeight() - 32);

  doc.save(`costos-arbitrales-${modoActual}.pdf`);
}

function reiniciarCalculadora(){
  estadoCalculadoras.unico = crearEstadoBase();
  estadoCalculadoras.tribunal = crearEstadoBase();
  modoActual = 'unico';
  document.querySelector('input[value="unico"]').checked = true;
  ultimoResultado = null;

  renderizarEstado(modoActual);
  actualizarEleccion();
  cerrarModal();
}
  </script>


</body>
</html>
